<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Verificador de Subida - Recepción Suite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-5">
    <div class="container bg-white p-4 shadow rounded">
        <h2>Probador de API de Subida</h2>
        <p class="text-muted">Usa esta página para probar si el servidor recibe archivos correctamente.</p>
        <hr>
        
        <div class="mb-3">
            <label class="form-label">Seleccionar Imagen de Prueba</label>
            <input type="file" id="testFile" class="form-control" accept="image/*">
        </div>
        
        <button class="btn btn-primary" onclick="testUpload()">Probar Subida</button>
        
        <div class="mt-4">
            <h5>Resultado:</h5>
            <pre id="result" class="p-3 bg-dark text-success rounded" style="min-height: 100px;">Esperando prueba...</pre>
        </div>

        <div class="mt-4">
            <h5>Últimos Logs del Servidor:</h5>
            <button class="btn btn-sm btn-secondary mb-2" onclick="loadLogs()">Actualizar Logs</button>
            <pre id="logs" class="p-3 bg-light border rounded" style="max-height: 300px; overflow-y: auto; font-size: 12px;"></pre>
        </div>
    </div>

    <script type="module">
        import { Api } from './assets/js/core/Api.js';
        import { MediaService } from './assets/js/services/MediaService.js';

        window.testUpload = async () => {
            const fileInput = document.getElementById('testFile');
            const result = document.getElementById('result');
            
            if (!fileInput.files[0]) return alert('Selecciona un archivo');
            
            result.textContent = 'Subiendo...';
            result.className = 'p-3 bg-dark text-warning rounded';

            try {
                const path = await MediaService.uploadImage(fileInput.files[0], 'test');
                result.textContent = '¡ÉXITO!\nArchivo guardado en: ' + path;
                result.className = 'p-3 bg-dark text-success rounded';
                loadLogs();
            } catch (err) {
                result.textContent = 'ERROR:\n' + err.message;
                result.className = 'p-3 bg-dark text-danger rounded';
                console.error(err);
                loadLogs();
            }
        };

        window.loadLogs = async () => {
            const logsArea = document.getElementById('logs');
            try {
                // Usamos el nuevo endpoint de nuestra API para leer el log
                const response = await fetch('/api/storage/debug/log?t=' + Date.now());
                if (response.ok) {
                    logsArea.textContent = await response.text();
                } else {
                    logsArea.textContent = 'El servidor no ha generado logs todavía (prueba a subir una foto primero).';
                }
            } catch (e) {
                logsArea.textContent = 'Error leyendo logs: ' + e.message;
            }
        };

        // Cargar logs al iniciar
        loadLogs();
    </script>
</body>
</html>
